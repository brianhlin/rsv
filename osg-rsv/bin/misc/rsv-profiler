#!/bin/sh

dir=`pwd`

if [ ! -w $dir ]; then
    echo "I'm sorry, I don't have permission to create rsv-profile.tar.gz"
    echo "in the current directory. Please change into a directory where"
    echo "you have permission, or switch to a user that does have permission"
    exit 1
fi

if [ "${VDT_LOCATION}" = "" ]
then
    echo "VDT_LOCATION is not defined. You need to source setup.sh or "
    echo "setup.csh before you can run the rsv-profiler."
    exit 1
fi

cd $VDT_LOCATION

filedirname=rsv-profile.files
rsvfiledir=$dir/$filedirname
export $rsvfiledir
if [ -e $rsvfiledir ]; then
  rm -fr $rsvfiledir
fi
mkdir $rsvfiledir
export rsvlog=$rsvfiledir/rsv-profile.txt
rm -f $rsvlog

echo "OSG-RSV Profiler"
echo "Analyzing..."


##
## Basic stuff
##

echo "OSG-RSV Profile " >> $rsvlog
date                    >> $rsvlog
echo ""                 >> $rsvlog
echo "Hostname:"        >> $rsvlog
/bin/hostname           >> $rsvlog
echo ""                 >> $rsvlog
echo "uname:"           >> $rsvlog
/bin/uname -a           >> $rsvlog
echo ""                 >> $rsvlog
echo "current user:"    >> $rsvlog
/usr/bin/whoami         >> $rsvlog
echo ""                 >> $rsvlog
echo "vdt-version:"     >> $rsvlog
vdt/bin/vdt-version     >> $rsvlog
echo ""                 >> $rsvlog
echo ""                 >> $rsvlog


##
## Condor stuff
##
echo "Condor information" >> $rsvlog

echo "Condor version:" >> $rsvlog
if [ -r condor-cron/wrappers/condor_cron_version ]; then 
  condor-cron/wrappers/condor_cron_version  >> $rsvlog 2>&1
else
  echo "cannot find condor_cron_version"    >> $rsvlog
fi
echo ""                                     >> $rsvlog


echo "condor_cron_q:" >> $rsvlog
if [ -r condor-cron/wrappers/condor_cron_q ]; then 
  condor-cron/wrappers/condor_cron_q  >> $rsvlog 2>&1
else
  echo "cannot find condor_cron_q"    >> $rsvlog
fi
echo ""                               >> $rsvlog

condor_log_dir=`condor-cron/wrappers/condor_cron_config_val log`
echo "Trying to copy condor logs from $condor_log_dir:" >> $rsvlog
if [ -d $condor_log_dir ]; then
  cp -p $condor_log_dir/*Log $rsvfiledir
  echo "copied condor logs"      >> $rsvlog
else
  echo "cannot find condor logs" >> $rsvlog
fi

echo "Trying to copy condor_conf file..." >> $rsvlog
if [ -r condor-cron/etc/condor_config ]; then
  cp condor-cron/etc/condor_config $rsvfiledir
  echo "copied condor_config"      >> $rsvlog
else
  echo "cannot find condor_config" >> $rsvlog
fi

echo "Trying to copy local condor config file..." >> $rsvlog
local_config=`condor-cron/wrappers/condor_cron_config_val LOCAL_CONFIG_FILE`
if [ -r $local_config ]; then
  cp $local_config $rsvfiledir
  echo "copied local config file $local_config"    >> $rsvlog
else
  echo "cannot find local condor-cron config file" >> $rsvlog
fi


##
## RSV stuff
##
echo "" >> $rsvlog
echo "" >> $rsvlog
echo "RSV information" >> $rsvlog
echo "" >> $rsvlog
echo "" >> $rsvlog

echo "Trying to copy submission files..." >> $rsvlog
if [ -d osg-rsv/submissions ]; then
  cp -pr osg-rsv/submissions $rsvfiledir
  echo "copying submission files"     >> $rsvlog
else
  echo "cannot find submission files" >> $rsvlog
fi
echo "" >> $rsvlog

echo "Trying to copy config directory..." >> $rsvlog
if [ -e osg-rsv/config ]; then
  cp -pr osg-rsv/config/ $rsvfiledir
  echo "copying config dir"     >> $rsvlog
else
  echo "cannot find config dir" >> $rsvlog
fi
echo "" >> $rsvlog

# See if there is anything in this directory
echo "Failed gratia directory:" >> $rsvlog
ls osg-rsv/output/failed-gratia-scripts >> $rsvlog 2>&1
echo "" >> $rsvlog

# Attempt to see if proxy exists
echo "Looking for RSV proxy..." >> $rsvlog
proxy=`grep proxy osg-rsv/submissions/probes/* | perl -e '$t = <STDIN>; if($t =~ /--proxy\s+(\S+)/) { print "$1\n" }'`
if [ ${proxy} = "" ]; then
  echo "Cannot figure out where proxy is.  Will run `ls -l /tmp/x509*` instead." >> $rsvlog
  ls -l /tmp/x509* >> $rsvlog
else
  echo "Proxy information:" >> $rsvlog
  ls -l $proxy >> $rsvlog
fi
echo "" >> $rsvlog

# Get proxy information
echo "Proxy information:" >> $rsvlog
id=`id -u`
user=`grep RUN_AS_USER post-install/osg-rsv | perl -e '$t = <STDIN>; if($t =~ /RUN_AS_USER\s*=\s*(\S+)/) { print "$1\n" }'`
if [ ${id} == "0" ]; then
  echo "grid-proxy-info:"                  >> $rsvlog
  su -c 'globus/bin/grid-proxy-info' $user >> $rsvlog
else
  echo "Not root, cannot get grid-proxy-info info" >> $rsvlog
fi
echo "" >> $rsvlog


# Get some information from the RSV and consumer logs
echo "Getting RSV probe and consumer logs:" >> $rsvlog
mkdir $rsvfiledir/logs
perl -e 'foreach $file (`ls -1 osg-rsv/logs/probes`) { chomp($file); system("echo $file >> $ENV{rsvlog}"); system("tail -1000 osg-rsv/logs/probes/$file > $ENV{rsvfiledir}/rsv-profile.files/logs/$file") }'
perl -e 'foreach $file (`ls -1 osg-rsv/logs/consumers`) { chomp($file); system("echo $file >> $ENV{rsvlog}"); system("tail -1000 osg-rsv/logs/consumers/$file > $ENV{rsvfiledir}/rsv-profile.files/logs/$file") }'
echo "" >> $rsvlog

echo "Done, making tarball" >> $rsvlog

# Make the tarball
echo "Making tarball (rsv-profile.tar.gz)"
cd $dir
if [ -e rsv-profile.tar.gz ]; then
  rm rsv-profile.tar.gz
fi

tar czf rsv-profile.tar.gz $filedirname
rm -fr $filedirname
