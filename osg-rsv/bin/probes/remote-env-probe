#!/usr/bin/env perl

###############################################################################
##
## Copyright 2009, The Trustees of Indiana University. 
##
## Open Science Grid Operations Team, Indiana University
## Original Author: Arvind Gopu (http://peart.ucs.indiana.edu)
##
## This Perl script prints the remote environment on an OSG service;
##  Details are in XML Format within the detailsData field
## Type ./osg-version-probe -h for more information
##
## REQUIRES
##  'RSV::Probe_Base'
##
################################################################################

######## Perl modules to use ######################################
use strict;
use RSVProbeBase;

######## Retrieve Global variables ################################
## And alias to RSV::Probe_Base variables
our %o;         *o         = \%RSVProbeBase::o;      
our %metric;    *metric    = \%RSVProbeBase::metric;

&RSVProbeBase::Init();
&RSVProbeBase::Run();

################################################################################
## Main Program ends ##
################################################################################


################################################################################
## Local Sub-Routines
################################################################################

sub Init {

    &RSVProbeBase::Set_MetricName ("org.osg.general.remote-env");

    ## Pass "status" or "performance" depending on metric type
    &RSVProbeBase::Set_MetricType ("status");
    &RSVProbeBase::Set_ServiceType ("OSG-CE");
    &RSVProbeBase::Set_ServiceVersion (">= OSG CE 1.0.0");
    &RSVProbeBase::Set_ProbeType ("OSG-Central-Monitoring");

    ## Should automating tools run this probe on above probeType by default?
    &RSVProbeBase::Set_EnableByDefault ("true");
    
    ## Unix cron type metric interval
    &RSVProbeBase::Set_MetricInterval ("1 21 * * *");

    ## Define this value from RCS/SVN version
    ## What version of the WLCG specification does this probe conform to?
    &RSVProbeBase::Set_ProbeRevision ('3.0');
    &RSVProbeBase::Set_ProbeSpecVersion ("0.91");

    ## Basic intro for the probe; This string will be used by Print_Usage ()
    &RSVProbeBase::Set_ProbeHelpIntro ("Probe to report the remote environment on a remote OSG service.");

    ## Additional options to print in Usage info used by Print_Usage ()
    ## &RSVProbeBase::Set_ProbeHelpOptions ("");

    ## Uncomment if you want additional command line options
    ## Optional second argument defines non-default %o hash key
    ## &RSVProbeBase::Extra_CLI_Option ("new-option=s","");

    ## Uncomment if you do not want detailsData to be trimmed to $o{'detailsDataMaxLength}
    &RSVProbeBase::Set_DetailsDataTrim ("False");
}


sub Run {
    my %remote_env = %{&RSVProbeBase::Get_Remote_Env()};

    my $tmp_string = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!-- This lists remote environment variables retrieved from URI $o{'serviceUri'} -->\n\n<RemoteEnv>\n";
    foreach my $key (sort keys %remote_env) {
        next if (($key !~ /^OSG_.*/)&&($key !~ /GLOBUS_LOCATION/));
	$tmp_string .= " <$key>". $remote_env{$key} . "</$key>\n";
    }
    $tmp_string .= "</RemoteEnv>\n";

    &RSVProbeBase::Set_Summary_Metric_Results (0,$tmp_string);
    &RSVProbeBase::Print_Metric();
}






